<!DOCTYPE HTML PUBLIC "-;;W3C;;DTD HTML 4.01;;EN" "http://www.w3.org/TR/html4/strict.dtd"><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<script>

load('lib/jsDump.js')

var rawString = function(str) {
	return "'"+str.replace(/'/g, "\\'")+"'";	
}
var charMult = function(character, multiplier) {
	var result = "";
	for(var n=0; n<multiplier; n++) result += character;
	return result;
}

function generateProgram(abstractRepresentation) {
	return {
		targets: abstractRepresentation.targets,
		body: 	"var program = "+buildStatement("scope", {v:['objectObj', abstractRepresentation.members]}).v+";\n"
				+"if(lima.helpers.obj.getMember(program.members['public'].privileged, lima.stringObj('main')) === undefined) throw 'There is no main function!'\n"
				+"dot(program,lima.stringObj('main')).primitiveValue();\n"
	};
}
	var scopeNumber = 0; // global variable to keep track of how many scopes have been created
	var newScope = function() {
		scopeNumber += 1;
		return "scope"+scopeNumber;	
	}
	var createScope = function(name, parentScope) {
		return "var "+name+" = {parent: "+parentScope+", variables: {}};"	
	}
	
	function buildStatement(parentScope, representation) {
		if(typeof(representation) === 'string') {
			print("Is this acutlaly bine used?");
			return representation; // variable
		} else {
			if(representation.n !== undefined)
				var name = buildStatement(parentScope, {v:representation.n}).v;
			var type = representation.v[0];
			var value = representation.v[1];
			
			var compiledValue;
			
			if(type === 'stringObj') {
				compiledValue = stringObj(value);	
				
			} else if(type === 'numberObj') {
				compiledValue = numberObj(value);	
				
			} else if(type === 'variable') {
				compiledValue = variable(parentScope, value);	
				
			} else if(type === 'expressionEvaluation') {
				for(var n=0; n<value.length; n+=2) { // go through every even value (the values that aren't oprators)
					value[n] = compileNameValuePair(buildStatement(parentScope, value[n]));
				}			
				compiledValue = expressionEvaluation(value);
				
			} else if(type === 'postOperation') {
				var op = representation.v[2];
				compiledValue = postOperation(buildStatement(parentScope,{v:value}).v, op);
				
			} else if(type === 'preOperation') {
				var op = representation.v[2];
				compiledValue = preOperation(buildStatement(parentScope,{v:value}).v, op);
				
			} else if(type === 'bracketOperation') {
				var op = representation.v[2];	
				var args = representation.v[3];	
						
				for(n in args) { 
					args[n] = compileNameValuePair(buildStatement(parentScope,args[n]));
				}						
				compiledValue = bracketOperation(compileNameValuePair(buildStatement(parentScope,value)), op, args);
				
			} else if(type === 'objectObj') {
				var scopeName = newScope();
				
				var members = value;
				for(n in members) { var m = members[n];
					var innerKey = m[0];
					var innerValue = m[1];
					var privileged = m[2];
					
					members[n] = [buildStatement(scopeName,{v:innerKey}).v, buildStatement(scopeName,innerValue).v, privileged];
				}
				
				compiledValue = objectObj(scopeName, parentScope, members);
			
			} else if(type === 'fnObject') {
				var scopeName = newScope();
				var statements = value;
				statements = statements.map(function(v){return buildStatement(scopeName, v).v});
				
				compiledValue = fnObject(scopeName, parentScope, statements); 
				
			// custom functions	
			} else if(type === 'var') {
				var variables = value;
				variables = variables.map(function(v){return parentScope+".variables["+rawString(v)+"]=lima.nil()";});
				
				//print("Got Variables: "+variables.join(";"));
				compiledValue = variables.join(";");
			
			} else {
				throw "Unknown type: "+type+" for representation "+jsDump.parse(representation);	
			}
			
			return {v:compiledValue, n:name};
		}
	}	
	
	
var stringObj = function(s) {
	return "lima.stringObj("+rawString(s)+")"
}
var numberObj = function(number) {
	return "lima.numberObj("+number+")"
}
var objectObj = function(scopeName, parentScope, members) {
	var objectRepresentationParts = [];
	for(var n in members) { var m = members[n];
		objectRepresentationParts.push("["+m[0]+","+m[1]+","+m[2]+"]");
	}
	
	return "(function() {"
				+createScope(scopeName, parentScope)
				+"return lima.objectObj("+scopeName+", ["+objectRepresentationParts.join(',')+"])"
			+"})()"
}
var variable = function(scopeName, variableName) {
	return "lima.variable("+scopeName+","+rawString(variableName)+")"
}
var fnObject = function(scopeName, parentScope, statements) {
	return "lima.fnObject(function() {"
		+createScope(scopeName, parentScope)
		+statements.join(";")
	+"})";
}	

var expressionEvaluation = function(expressionParts) {
	if(expressionParts.length === 1) return expressionParts[0];
	else return "lima.evalExpression(["+expressionParts.join(',')+"])"
}	
var postOperation = function(value, operator) {
	return "lima.evalPostOperation(scope,"+value+","+rawString(operator)+")"
}	
var preOperation = function(value, operator) {
	return "lima.evalPreOperation(scope,"+value+","+rawString(operator)+")"
}
var bracketOperation = function(value, operator, args) {
	return "lima.evalBracketOperation(scope,"+value+","+rawString(operator)+",["+args.join(',')+"])"
}	

var compileNameValuePair = function(rawNameValuePair) {
	var result = "{v:"+rawNameValuePair.v;
	if(rawNameValuePair.n !== undefined) {
		result += ",n:"+rawNameValuePair.n;
	}
	result += "}";
	
	return result;
}
;
var abstractRepresentation = {
   "targets": [
      "browser",
      "rhino"
   ],
   "members": [
      [
         [
            "numberObj",
            0
         ],
         {
            "v": [
               "numberObj",
               1
            ],
            "n": [
               "numberObj",
               1
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            1
         ],
         {
            "v": [
               "numberObj",
               12345
            ],
            "n": [
               "numberObj",
               12345
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            2
         ],
         {
            "v": [
               "numberObj",
               45
            ],
            "n": [
               "numberObj",
               45
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            3
         ],
         {
            "v": [
               "stringObj",
               "hello"
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            4
         ],
         {
            "v": [
               "stringObj",
               "cat"
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            5
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "numberObj",
                        0
                     ],
                     {
                        "v": [
                           "numberObj",
                           1
                        ],
                        "n": [
                           "numberObj",
                           1
                        ]
                     },
                     false
                  ],
                  [
                     [
                        "numberObj",
                        1
                     ],
                     {
                        "v": [
                           "numberObj",
                           2
                        ],
                        "n": [
                           "numberObj",
                           2
                        ]
                     },
                     false
                  ],
                  [
                     [
                        "numberObj",
                        2
                     ],
                     {
                        "v": [
                           "numberObj",
                           3
                        ],
                        "n": [
                           "numberObj",
                           3
                        ]
                     },
                     false
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            6
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "stringObj",
                        "moo"
                     ],
                     {
                        "v": [
                           "numberObj",
                           5
                        ],
                        "n": [
                           "numberObj",
                           5
                        ]
                     },
                     false
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            7
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "stringObj",
                        "moo2"
                     ],
                     {
                        "v": [
                           "numberObj",
                           5
                        ],
                        "n": [
                           "numberObj",
                           5
                        ]
                     },
                     true
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            8
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "stringObj",
                        "moo3"
                     ],
                     {
                        "v": [
                           "numberObj",
                           5
                        ],
                        "n": [
                           "numberObj",
                           5
                        ]
                     },
                     false
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            9
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "stringObj",
                        "moo4"
                     ],
                     {
                        "v": [
                           "numberObj",
                           5
                        ],
                        "n": [
                           "numberObj",
                           5
                        ]
                     },
                     true
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            10
         ],
         {
            "v": [
               "expressionEvaluation",
               [
                  {
                     "v": [
                        "numberObj",
                        2
                     ],
                     "n": [
                        "numberObj",
                        2
                     ]
                  },
                  "'*'",
                  {
                     "v": [
                        "expressionEvaluation",
                        [
                           {
                              "v": [
                                 "numberObj",
                                 3
                              ],
                              "n": [
                                 "numberObj",
                                 3
                              ]
                           },
                           "'+'",
                           {
                              "v": [
                                 "numberObj",
                                 4
                              ],
                              "n": [
                                 "numberObj",
                                 4
                              ]
                           }
                        ]
                     ]
                  }
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            11
         ],
         {
            "v": [
               "expressionEvaluation",
               [
                  {
                     "v": [
                        "numberObj",
                        3
                     ],
                     "n": [
                        "numberObj",
                        3
                     ]
                  },
                  "'*'",
                  {
                     "v": [
                        "numberObj",
                        5
                     ],
                     "n": [
                        "numberObj",
                        5
                     ]
                  }
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            12
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "numberObj",
                        0
                     ],
                     {
                        "v": [
                           "numberObj",
                           1
                        ],
                        "n": [
                           "numberObj",
                           1
                        ]
                     },
                     false
                  ],
                  [
                     [
                        "numberObj",
                        1
                     ],
                     {
                        "v": [
                           "expressionEvaluation",
                           [
                              {
                                 "v": [
                                    "numberObj",
                                    7
                                 ],
                                 "n": [
                                    "numberObj",
                                    7
                                 ]
                              },
                              "'*'",
                              {
                                 "v": [
                                    "numberObj",
                                    3
                                 ],
                                 "n": [
                                    "numberObj",
                                    3
                                 ]
                              }
                           ]
                        ]
                     },
                     false
                  ],
                  [
                     [
                        "numberObj",
                        2
                     ],
                     {
                        "v": [
                           "expressionEvaluation",
                           [
                              {
                                 "v": [
                                    "numberObj",
                                    2
                                 ],
                                 "n": [
                                    "numberObj",
                                    2
                                 ]
                              },
                              "'+'",
                              {
                                 "v": [
                                    "numberObj",
                                    4
                                 ],
                                 "n": [
                                    "numberObj",
                                    4
                                 ]
                              }
                           ]
                        ]
                     },
                     false
                  ],
                  [
                     [
                        "numberObj",
                        3
                     ],
                     {
                        "v": [
                           "stringObj",
                           "cat"
                        ]
                     },
                     false
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            13
         ],
         {
            "v": [
               "objectObj",
               [
                  [
                     [
                        "stringObj",
                        "a"
                     ],
                     {
                        "v": [
                           "numberObj",
                           1
                        ],
                        "n": [
                           "numberObj",
                           1
                        ]
                     },
                     true
                  ],
                  [
                     [
                        "stringObj",
                        "b"
                     ],
                     {
                        "v": [
                           "numberObj",
                           2
                        ],
                        "n": [
                           "numberObj",
                           2
                        ]
                     },
                     true
                  ]
               ]
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            14
         ],
         {
            "v": [
               "numberObj",
               2
            ],
            "n": [
               "numberObj",
               2
            ]
         },
         false
      ],
      [
         [
            "numberObj",
            15
         ],
         {
            "v": [
               "expressionEvaluation",
               [
                  {
                     "v": [
                        "numberObj",
                        2
                     ],
                     "n": [
                        "numberObj",
                        2
                     ]
                  },
                  "'+'",
                  {
                     "v": [
                        "numberObj",
                        3
                     ],
                     "n": [
                        "numberObj",
                        3
                     ]
                  },
                  "'+'",
                  {
                     "v": [
                        "numberObj",
                        4
                     ],
                     "n": [
                        "numberObj",
                        4
                     ]
                  },
                  "'+'",
                  {
                     "v": [
                        "numberObj",
                        5
                     ],
                     "n": [
                        "numberObj",
                        5
                     ]
                  }
               ]
            ]
         },
         false
      ],
      [
         [
            "stringObj",
            "a"
         ],
         {
            "v": [
               "numberObj",
               5
            ],
            "n": [
               "numberObj",
               5
            ]
         },
         true
      ],
      [
         [
            "stringObj",
            "b"
         ],
         {
            "v": [
               "stringObj",
               "cat"
            ]
         },
         true
      ],
      [
         [
            "stringObj",
            "c"
         ],
         {
            "v": [
               "numberObj",
               12
            ],
            "n": [
               "numberObj",
               12
            ]
         },
         false
      ],
      [
         [
            "stringObj",
            "test"
         ],
         {
            "v": [
               "fnObject",
               [
                  {
                     "v": [
                        "var",
                        [
                           "a"
                        ]
                     ]
                  },
                  {
                     "v": [
                        "expressionEvaluation",
                        [
                           {
                              "v": [
                                 "variable",
                                 "a"
                              ],
                              "n": [
                                 "stringObj",
                                 "a"
                              ]
                           },
                           "'='",
                           {
                              "v": [
                                 "objectObj",
                                 [
                                    [
                                       [
                                          "stringObj",
                                          "x"
                                       ],
                                       {
                                          "v": [
                                             "stringObj",
                                             "Nurse"
                                          ]
                                       },
                                       true
                                    ]
                                 ]
                              ]
                           }
                        ]
                     ]
                  },
                  {
                     "v": [
                        "bracketOperation",
                        {
                           "v": [
                              "variable",
                              "wout"
                           ],
                           "n": [
                              "stringObj",
                              "wout"
                           ]
                        },
                        "[",
                        [
                           {
                              "v": [
                                 "expressionEvaluation",
                                 [
                                    {
                                       "v": [
                                          "variable",
                                          "a"
                                       ],
                                       "n": [
                                          "stringObj",
                                          "a"
                                       ]
                                    },
                                    "'.'",
                                    {
                                       "v": [
                                          "variable",
                                          "x"
                                       ],
                                       "n": [
                                          "stringObj",
                                          "x"
                                       ]
                                    }
                                 ]
                              ]
                           }
                        ]
                     ]
                  }
               ]
            ]
         },
         true
      ],
      [
         [
            "stringObj",
            "main"
         ],
         {
            "v": [
               "fnObject",
               [
                  {
                     "v": [
                        "bracketOperation",
                        {
                           "v": [
                              "variable",
                              "wout"
                           ],
                           "n": [
                              "stringObj",
                              "wout"
                           ]
                        },
                        "[",
                        [
                           {
                              "v": [
                                 "stringObj",
                                 "Hellooooooo"
                              ]
                           }
                        ]
                     ]
                  },
                  {
                     "v": [
                        "bracketOperation",
                        {
                           "v": [
                              "variable",
                              "test"
                           ],
                           "n": [
                              "stringObj",
                              "test"
                           ]
                        },
                        "[",
                        []
                     ]
                  },
                  {
                     "v": [
                        "bracketOperation",
                        {
                           "v": [
                              "variable",
                              "wout"
                           ],
                           "n": [
                              "stringObj",
                              "wout"
                           ]
                        },
                        "[",
                        [
                           {
                              "v": [
                                 "variable",
                                 "a"
                              ],
                              "n": [
                                 "stringObj",
                                 "a"
                              ]
                           }
                        ]
                     ]
                  },
                  {
                     "v": [
                        "bracketOperation",
                        {
                           "v": [
                              "variable",
                              "wout"
                           ],
                           "n": [
                              "stringObj",
                              "wout"
                           ]
                        },
                        "[",
                        [
                           {
                              "v": [
                                 "variable",
                                 "b"
                              ],
                              "n": [
                                 "stringObj",
                                 "b"
                              ]
                           }
                        ]
                     ]
                  }
               ]
            ]
         },
         true
      ]
   ]
};
var program = generateProgram(abstractRepresentation);
</script></html>